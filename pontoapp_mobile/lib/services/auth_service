// lib/services/auth_service.dart
import 'package:dartz/dartz.dart';
import 'package:dio/dio.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:pontoapp/core/network/api_client.dart';
import 'package:pontoapp/core/constants/storage_keys.dart';
import 'package:pontoapp/core/errors/failures.dart';
import 'package:pontoapp/core/services/device_info_service.dart';
import 'package:pontoapp/models/user.dart';
import 'package:pontoapp/models/device.dart';

class AuthService {
  final ApiClient _api;
  final FlutterSecureStorage _storage;
  final DeviceInfoService _deviceInfo;

  AuthService(this._api, this._storage, this._deviceInfo);

  Future<Either<Failure, User>> login(String email, String password) async {
    try {
      final response = await _api.login(LoginRequest(
        email: email,
        password: password,
      ));

      await _storage.write(key: StorageKeys.accessToken, value: response.token);
      await _storage.write(key: StorageKeys.userId, value: response.user.id);
      await _storage.write(key: StorageKeys.tenantId, value: response.tenantId);
      await _storage.write(
          key: StorageKeys.userName, value: response.user.fullName);

      await _registerDevice();

      return Right(response.user);
    } on DioException catch (e) {
      final message = e.response?.data?['message'] ?? 'Erro no login';
      return Left(AuthFailure(message));
    } catch (e) {
      return Left(AuthFailure('Erro inesperado: $e'));
    }
  }

  Future<void> _registerDevice() async {
    try {
      final request = RegisterDeviceRequest(
        deviceId: await _deviceInfo.getOrCreateDeviceId(),
        platform: await _deviceInfo.getPlatform(),
        model: await _deviceInfo.getModel(),
        osVersion: await _deviceInfo.getOsVersion(),
        biometricCapable: await _deviceInfo.isBiometricCapable(),
      );
      await _api.registerDevice(request);
    } catch (_) {
      // Silent fail - don't block login
    }
  }

  Future<bool> isAuthenticated() async {
    final token = await _storage.read(key: StorageKeys.accessToken);
    return token != null;
  }

  Future<String?> getUserName() async {
    return await _storage.read(key: StorageKeys.userName);
  }

  Future<void> logout() async {
    await _storage.deleteAll();
  }
}